---
title: SFX-инсталлятор для Portable программ
date: 2021-11-11T11:11:11+02:00
modified: 2023-03-25T10:26:00
tags: native
---

Установщик предназначен для корректной интеграции программы в систему. Настроит все переменные, выставит разрешения и создаст ярлыки, если это нужно. Задача эта, при разработке нативных приложений, встречается часто. 

- Навигатор
{: toc }


## Какие есть решения
Есть готовые решения, да. Но мне лично удобнее иметь обычный архив вместо бинарника. Для его распаковки не нужны дополнительные инструменты.


- Просто zip-архив - большинство portrable пролграмм так распространяются
- Nullsoft Install Sastem
- Inno Setup
- В винде можно генерировать MSI, это тоже что-то типа инсталлятора
- Самораспаковывающийся архив WinRAR SFX

Архиватор WinRAR позволяет тонко настраивать сценарий распаковки. Но если очень надо, можно написать вспомогательный скрипт install.bat


## Что требуется для установки

- Распаковка в папку `C:\soft`
- Создать ярлык в меню "Пуск"
- После завершения открыть распакованную папку
- Если требуется, подождать завершения установки. Подробнее тут: [распаковка многофайлового установщика](#temp)

Использую такой скрипт для программ, которые выкладываю в телеграм-канале [@FeelSoft](https://t.me/feelsoft). Соответственно, требования составлял для себя

## Сценарий распаковки Portable

;Упаковывать именно файлы, а не папку  
;Тип архива: ZIP  
;В названии файла добавить номер версии  
;Галка "Создать SFX-архив"  
;Установить пароль "123" (если нужен)  
;Вставить сценарий на вкладке "Комментарий"  
;Поменять содержимое строк Path и Shortcut по вкусу  

	Path=%SYSTEMDRIVE%\soft\WizTree
	SavePath
	Setup=.\
	Title=Установка...
	Text
	{
	Программа распространяется "как есть" и нет никаких
	гарантий что у вас она будет корректно работать.<br><br>
	Инсталлятор создаст ярлык в меню "Пуск"<br><br>
	<b>Желаете продолжить?</b><br>
	Чтобы узнать пароль, решите задачку: <br>
	100+23=?
	}
	Shortcut=P, ".\", , , "WizTree", 



## Распаковка многофайлового установщика
{: #temp }

Когда программа распространяется в виде набора файлов, не всегда удобно делиться инсталлятором. Поэтому я упаковываю такие проги в один sfx-архив. WinRAR может взять на себя функцию мониторинга за процессом установки. Но я все-равно сделал дополнительный скрипт-прокладку. Он запускаясь создает большое черное окно, так я могу понять что инсталлятор начал запускаться (иногда это важно). И что установка еще продолжается. 

**Сценарий SFX-архива**  

В архиваторе надо указать, что бы он распаковывался во временную папку. После завершения установки модуль SFX уберется за собой и удалит временную папку.

;Расположенный ниже комментарий содержит команды SFX-сценария

	Setup=install.bat
	TempMode="Что-бы продолжить реши задачку:\n  100+23=?","Распковка..."
	Silent=2

Задачка здесь нужна как защита от дурака при распаковке опасных программ. Если архив будет не запаролен, поле ввода просто не появится. Строкой `Silent=2` просто настраиваем красоту в окошках


**Скрипт install.bat**

Скрипт определяет какой разрядности система. В зависимости от этого он может запустить для установки файл нужной разрядности. Это работатет в Windows 10 и не работает в Windows 7

``` batch
if defined PROCESSOR_ARCHITEW6432 (set arch=64) else If "%PROCESSOR_ARCHITECTURE%"=="AMD64" (set arch=64)
```

При обновлении версии программы меняется имя исполняемого файла. Но скрипт ведь умный, он может подобрать нужное имя по маске

	FOR %%i IN ("WinRar*_RusX64.exe") DO Set FileName="%%i"

Осталось сделать bat-файл, расставить IF в нужных местах и в путь



	@echo off
	@chcp 1251 > nul
	title Installing...
	cd /d %~dp0
	cd
	echo. Выполняется установка...
	if defined PROCESSOR_ARCHITEW6432 (set arch=64) else If "%PROCESSOR_ARCHITECTURE%"=="AMD64" (set arch=64)
	if %arch%==64 (
		echo. Версия: 64bit
		FOR %%i IN ("WinRar*_RusX64.exe") DO Set FileName="%%i"
	) else (
		echo. Версия: 32bit
		FOR %%i IN ("WinRar*_RusX32.exe") DO Set FileName="%%i"
	)
	echo. Файл:  %FileName%
	start "" /wait %FileName%
	timeout /t 1 >nul
	echo.
	echo. УСТАНОВКА ЗАВЕРШЕНА
	echo. 
	timeout /t 4
	exit
	

**Результат**
![image](https://user-images.githubusercontent.com/17731587/227705977-93ce355a-b7b4-4726-a7db-d17ae3623539.png)


